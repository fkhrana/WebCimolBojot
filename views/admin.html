<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - Cimol Bojot AA</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="/styleadmin.css" />
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
</head>
<body>
    <div class="navbar">
        <div class="navbar-header">
            <img src="/logocimoladmin.png" alt="Logo Cimol Bojot AA" />
            <div class="title">
                <h1>ADMIN</h1>
                <p>CIMOL BOJOT AA</p>
            </div>
        </div>
        <div class="navbar-divider"></div>
        <ul>
            <li><a href="/admin" class="active">PESANAN</a></li>
            <li><a href="/masukan">MASUKAN</a></li>
        </ul>
    </div>
    <div class="main-content">
        <div class="top-bar">
            <h2>HALO AA!</h2>
            <div class="admin-info"><b>{{cabangName}}</b></div>
        </div>
        <div class="order-container">
            <div id="pesanan">
                <div class="filter-container">
                    <label for="status-filter">Filter Status:</label>
                    <select id="status-filter" name="status" 
                            hx-get="/api/orders" 
                            hx-target="#order-list" 
                            hx-swap="innerHTML" 
                            hx-trigger="change"
                            hx-indicator=".htmx-indicator">
                        <option value="">Semua</option>
                        <option value="pending">Menunggu</option>
                        <option value="confirmed">Diterima</option>
                        <option value="completed">Selesai</option>
                    </select>
                    <span class="htmx-indicator">Memuat...</span>
                </div>
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>NO.</th>
                            <th>NAMA</th>
                            <th>PESANAN</th>
                            <th>JUMLAH</th>
                            <th>HARGA</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="order-list" hx-get="/api/orders" hx-trigger="load" hx-swap="innerHTML" hx-indicator=".htmx-indicator">
                        <!-- Data pesanan akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        document.body.addEventListener('htmx:afterSwap', (event) => {
            if (event.detail.target.id === 'order-list') {
                try {
                    const orders = JSON.parse(event.detail.xhr.responseText);
                    console.log('Orders loaded:', orders);
                    const container = event.detail.target;
                    if (orders.length === 0) {
                        container.innerHTML = '<tr><td colspan="6">Tidak ada pesanan untuk status ini.</td></tr>';
                        return;
                    }
                    container.innerHTML = orders.map(order => `
                        <tr>
                            <td>${order.no}</td>
                            <td>${order.nama}</td>
                            <td>
                                <div class="order-details">
                                    <div class="menu-name">${order.menu}</div>
                                    <div class="details">
                                        Bumbu: ${order.bumbu}<br>
                                        Topping: ${order.topping}<br>
                                        Level: ${order.level}<br>
                                        Note: ${order.catatan}
                                    </div>
                                </div>
                            </td>
                            <td>${order.quantity}</td>
                            <td>Rp${order.harga.toLocaleString('id-ID')}</td>
                            <td>
                                <select class="status-dropdown" data-order-id="${order.id_order}">
                                    <option value="pending" ${order.status === 'Menunggu' ? 'selected' : ''}>Menunggu</option>
                                    <option value="confirmed" ${order.status === 'Diterima' ? 'selected' : ''}>Diterima</option>
                                    <option value="completed" ${order.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                                </select>
                            </td>
                        </tr>
                    `).join('');

                    // Tambah event listener untuk dropdown
                    document.querySelectorAll('.status-dropdown').forEach(dropdown => {
                        dropdown.addEventListener('change', async (event) => {
                            const orderId = event.target.getAttribute('data-order-id');
                            const status = event.target.value;
                            console.log('Dropdown changed:', { orderId, status });

                            try {
                                const response = await fetch(`/api/orders/${orderId}/status`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ status })
                                });
                                const result = await response.json();
                                console.log('Update response:', result);

                                if (result.success) {
                                    const statusFilter = document.getElementById('status-filter').value || '';
                                    console.log('Refreshing table with filter:', statusFilter);
                                    htmx.ajax('GET', `/api/orders${statusFilter ? `?status=${statusFilter}` : ''}`, {
                                        target: '#order-list',
                                        swap: 'innerHTML'
                                    });
                                } else {
                                    console.error('Update failed:', result.error);
                                    alert('Gagal update status: ' + result.error);
                                }
                            } catch (err) {
                                console.error('Error:', err);
                                alert('Error: Gagal kirim request');
                            }
                        });
                    });
                } catch (err) {
                    console.error('Error parsing JSON:', err);
                    container.innerHTML = '<tr><td colspan="6">Gagal memuat pesanan.</td></tr>';
                }
            }
        });
    </script>
</body>
</html>